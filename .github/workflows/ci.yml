name: CI/CD

on:
  push:
    branches: ["main"]
    tags: ["v*"]  # for releases

permissions:
  contents: write  # Required for creating releases

jobs:
  check_changes:
    name: Check if server code changed
    runs-on: ubuntu-latest
    outputs:
      server_changed: ${{ steps.filter.outputs.server }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for server changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            server:
              - 'sedidata-server/**'
              - 'Cargo.toml'
              - 'Cargo.lock'

  build:
    name: Build all workspace crates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-gnu

      - name: Install MinGW
        run: sudo apt-get update && sudo apt-get install -y mingw-w64

      - name: Build all crates
        run: cargo build --release --target x86_64-pc-windows-gnu

      - name: Upload TUI binary artifact
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: sedidata-tui
          path: target/x86_64-pc-windows-gnu/release/sedidata-tui.exe
          retention-days: 1

  release:
    name: Release main binary on tags
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: sedidata-tui
          path: ./artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./artifacts/sedidata-tui.exe
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false

  deploy_render:
    name: Deploy HTTP proxy to Render
    needs: [check_changes, build]
    if: |
      github.ref == 'refs/heads/main' &&
      needs.check_changes.outputs.server_changed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Render
        run: |
          curl -X POST \
              -H "Accept: application/json" \
              -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
              -d '{"clearCache": "clear"}' \
              https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys
